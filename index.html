<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Team ELAN - Crafting Recipes Editor</title>
  <style>
    :root {
      --bg-dark: #18181b;
      --bg-darker: #121214;
      --bg-medium: #27272a;
      --bg-light: #3f3f46;
      --border-color: #52525b;
      --text-light: #f4f4f5;
      --text-medium: #d4d4d8;
      --text-dim: #a1a1aa;
      --accent-color: #3b82f6;
      --accent-hover: #2563eb;
      --success-color: #10b981;
      --error-color: #ef4444;
      --warning-color: #f59e0b;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    }

    body {
      background-color: var(--bg-dark);
      color: var(--text-light);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background-color: var(--bg-medium);
      border-bottom: 1px solid var(--border-color);
      padding: 1rem;
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    h1 {
      font-size: 1.5rem;
      font-weight: bold;
    }

    .main-container {
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    .sidebar {
      width: 300px;
      background-color: var(--bg-medium);
      border-right: 1px solid var(--border-color);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    .sidebar-header {
      padding: 1rem;
      border-bottom: 1px solid var(--border-color);
    }

    .sidebar-content {
      flex: 1;
      padding: 1rem;
      overflow-y: auto;
    }

    .sidebar-footer {
      padding: 1rem;
      border-top: 1px solid var(--border-color);
      display: flex;
      gap: 0.5rem;
    }

    .editor-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .editor-header {
      padding: 1rem;
      background-color: var(--bg-medium);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .editor-content {
      flex: 1;
      padding: 1rem;
      overflow-y: auto;
    }

    .editor-footer {
      padding: 1rem;
      background-color: var(--bg-medium);
      border-top: 1px solid var(--border-color);
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
    }

    .button {
      padding: 0.5rem 1rem;
      background-color: var(--accent-color);
      color: var(--text-light);
      border: none;
      border-radius: 0.25rem;
      cursor: pointer;
      font-size: 0.875rem;
      transition: background-color 0.2s;
    }

    .button:hover {
      background-color: var(--accent-hover);
    }

    .button.secondary {
      background-color: var(--bg-light);
    }

    .button.secondary:hover {
      background-color: var(--border-color);
    }

    .button.success {
      background-color: var(--success-color);
    }

    .button.success:hover {
      background-color: #059669;
    }

    .button.danger {
      background-color: var(--error-color);
    }

    .button.danger:hover {
      background-color: #dc2626;
    }

    .button.warning {
      background-color: var(--warning-color);
    }

    .button.warning:hover {
      background-color: #d97706;
    }

    .button.small {
      padding: 0.25rem 0.5rem;
      font-size: 0.75rem;
    }

    .button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .file-input {
      display: none;
    }

    .tree-view {
      margin-top: 1rem;
    }

    .tree-item {
      margin-bottom: 0.5rem;
    }

    .tree-item-header {
      display: flex;
      align-items: center;
      padding: 0.5rem;
      background-color: var(--bg-light);
      border-radius: 0.25rem;
      cursor: pointer;
      justify-content: space-between;
      margin-bottom: 0.25rem; /* Add spacing between items */
    }

    .tree-item-header:hover {
      background-color: var(--border-color);
    }

    .tree-item-header.active {
      background-color: var(--accent-color);
    }

    .tree-item-content {
      margin-left: 1.5rem;
      margin-top: 0.5rem;
    }

    .tree-item-actions {
      margin-left: auto;
      display: flex;
      gap: 0.25rem;
    }

    .chevron-icon {
      width: 16px;
      height: 16px;
      margin-right: 0.5rem;
      transition: transform 0.2s;
    }

    .chevron-icon.expanded {
      transform: rotate(90deg);
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-label {
      display: block;
      margin-bottom: 0.5rem;
      font-size: 0.875rem;
      color: var(--text-medium);
    }

    .form-input {
      width: 100%;
      padding: 0.5rem;
      background-color: var(--bg-light);
      border: 1px solid var(--border-color);
      border-radius: 0.25rem;
      color: var(--text-light);
      font-size: 0.875rem;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--accent-color);
    }

    .form-select {
      width: 100%;
      padding: 0.5rem;
      background-color: var(--bg-light);
      border: 1px solid var(--border-color);
      border-radius: 0.25rem;
      color: var(--text-light);
      font-size: 0.875rem;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23a1a1aa' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 0.5rem center;
      background-size: 1rem;
    }

    .form-select:focus {
      outline: none;
      border-color: var(--accent-color);
    }

    .form-textarea {
      width: 100%;
      min-height: 200px;
      padding: 0.5rem;
      background-color: var(--bg-light);
      border: 1px solid var(--border-color);
      border-radius: 0.25rem;
      color: var(--text-light);
      font-size: 0.875rem;
      font-family: monospace;
      resize: vertical;
    }

    .form-textarea:focus {
      outline: none;
      border-color: var(--accent-color);
    }

    .form-checkbox {
      margin-right: 0.5rem;
    }

    .form-help {
      margin-top: 0.25rem;
      font-size: 0.75rem;
      color: var(--text-dim);
    }

    .alert {
      padding: 0.75rem 1rem;
      border-radius: 0.25rem;
      margin-bottom: 1rem;
      font-size: 0.875rem;
    }

    .alert.success {
      background-color: rgba(16, 185, 129, 0.2);
      border: 1px solid var(--success-color);
      color: var(--success-color);
    }

    .alert.error {
      background-color: rgba(239, 68, 68, 0.2);
      border: 1px solid var(--error-color);
      color: var(--error-color);
    }

    .alert.warning {
      background-color: rgba(245, 158, 11, 0.2);
      border: 1px solid var(--warning-color);
      color: var(--warning-color);
    }

    .alert.info {
      background-color: rgba(59, 130, 246, 0.2);
      border: 1px solid var(--accent-color);
      color: var(--accent-color);
    }

    .tabs {
      display: flex;
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 1rem;
    }

    .tab {
      padding: 0.5rem 1rem;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      color: var(--text-dim);
    }

    .tab:hover {
      color: var(--text-medium);
    }

    .tab.active {
      color: var(--text-light);
      border-bottom-color: var(--accent-color);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .material-list {
      margin-top: 0.5rem;
    }

    .material-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
      padding: 0.5rem;
      background-color: var(--bg-light);
      border-radius: 0.25rem;
    }

    .material-item-name {
      flex: 1;
    }

    .material-item-quantity {
      width: 80px;
    }

    .add-material-button {
      margin-top: 0.5rem;
    }

    .component-list {
      margin-top: 0.5rem;
    }

    .component-item {
      margin-bottom: 1rem;
      padding: 0.75rem;
      background-color: var(--bg-light);
      border-radius: 0.25rem;
    }

    .component-header {
      display: flex;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .component-name {
      flex: 1;
    }

    .component-quantity {
      width: 80px;
      margin-right: 0.5rem;
    }

    .component-materials {
      margin-top: 0.5rem;
      padding-top: 0.5rem;
      border-top: 1px solid var(--border-color);
    }

    .component-submaterials {
      margin-top: 0.5rem;
      padding-top: 0.5rem;
      border-top: 1px solid var(--border-color);
    }

    .add-component-button {
      margin-top: 0.5rem;
    }

    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal {
      background-color: var(--bg-medium);
      border-radius: 0.5rem;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .modal-header {
      padding: 1rem;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-size: 1.25rem;
      font-weight: bold;
    }

    .modal-close {
      background: none;
      border: none;
      color: var(--text-dim);
      cursor: pointer;
      font-size: 1.5rem;
    }

    .modal-close:hover {
      color: var(--text-light);
    }

    .modal-body {
      padding: 1rem;
    }

    .modal-footer {
      padding: 1rem;
      border-top: 1px solid var(--border-color);
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
    }

    .hidden {
      display: none !important;
    }

    .loading-spinner {
      border: 4px solid var(--bg-light);
      border-top: 4px solid var(--accent-color);
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .json-editor {
      width: 100%;
      height: 100%;
      min-height: 400px;
      font-family: monospace;
      font-size: 14px;
      line-height: 1.5;
      padding: 1rem;
      background-color: var(--bg-light);
      color: var(--text-light);
      border: 1px solid var(--border-color);
      border-radius: 0.25rem;
      resize: none;
    }

    .json-editor:focus {
      outline: none;
      border-color: var(--accent-color);
    }

    .preview-image {
      max-width: 100%;
      max-height: 150px;
      object-fit: contain;
      margin-top: 0.5rem;
      background-color: var(--bg-darker);
      border-radius: 0.25rem;
      padding: 0.5rem;
    }

    @media (max-width: 768px) {
      .main-container {
        flex-direction: column;
      }

      .sidebar {
        width: 100%;
        max-height: 300px;
      }
    }

    .materials-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.5rem;
      background-color: var(--bg-darker);
      border-radius: 0.25rem;
    }

    .materials-table th,
    .materials-table td {
      padding: 0.5rem;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
    }

    .materials-table th {
      font-weight: bold;
      background-color: var(--bg-medium);
    }

    .materials-table td.text-center {
      text-align: center;
    }

    .submaterial-group {
      margin-top: 0.75rem;
      padding: 0.5rem;
      background-color: var(--bg-darker);
      border-radius: 0.25rem;
    }

    .submaterial-group h4 {
      margin-bottom: 0.5rem;
      font-size: 0.875rem;
      font-weight: bold;
    }

    /* Füge diese CSS-Regeln zum Stylesheet hinzu */
    .sort-buttons {
      display: flex;
      gap: 0.25rem;
      margin-left: auto;
    }

    .sort-button {
      background: none;
      border: none;
      color: var(--text-dim);
      cursor: pointer;
      padding: 0.25rem;
      border-radius: 0.25rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .sort-button:hover {
      background-color: var(--bg-medium);
      color: var(--text-light);
    }

    .sort-button svg {
      width: 16px;
      height: 16px;
    }

    .tree-item-header {
      justify-content: space-between;
    }

    .tree-item-header-content {
      display: flex;
      align-items: center;
      flex: 1;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="header-content">
      <h1>Team ELAN - Crafting Recipes Editor</h1>
    </div>
  </header>

  <div class="main-container">
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="sidebar-header">
        <h2>Crafting Data</h2>
      </div>
      <div class="sidebar-content">
        <div id="tree-view" class="tree-view">
          <!-- Tree view will be populated by JavaScript -->
        </div>
      </div>
      <div class="sidebar-footer">
        <input type="file" id="file-input" class="file-input" accept=".json">
        <button id="load-button" class="button">Load JSON</button>
        <button id="load-url-button" class="button">Load from URL</button>
        <button id="save-button" class="button success">Save JSON</button>
      </div>
    </div>

    <!-- Editor -->
    <div class="editor-container">
      <div class="editor-header">
        <h2 id="editor-title">Editor</h2>
        <div>
          <button id="add-category-button" class="button">Add Category</button>
          <button id="add-subcategory-button" class="button">Add Subcategory</button>
          <button id="add-item-button" class="button">Add Item</button>
        </div>
      </div>
      <div class="editor-content">
        <div id="welcome-screen">
          <div class="alert info">
            Welcome to the Arma Reforger Crafting Editor. Load a JSON file to get started or create a new one.
          </div>
          <div class="form-group">
            <button id="create-new-button" class="button">Create New JSON</button>
          </div>
        </div>

        <div id="category-editor" class="hidden">
          <div class="form-group">
            <label for="category-key" class="form-label">Category Key</label>
            <input type="text" id="category-key" class="form-input" placeholder="e.g. weapons">
            <div class="form-help">This is used as the identifier in the JSON structure.</div>
          </div>
          <div class="form-group">
            <label for="category-name" class="form-label">Category Name</label>
            <input type="text" id="category-name" class="form-input" placeholder="e.g. Weapons">
            <div class="form-help">This is the display name shown to users.</div>
          </div>
          <div class="form-group">
            <button id="save-category-button" class="button success">Save Category</button>
            <button id="delete-category-button" class="button danger">Delete Category</button>
          </div>
        </div>

        <div id="subcategory-editor" class="hidden">
          <div class="form-group">
            <label for="subcategory-parent" class="form-label">Parent Category</label>
            <select id="subcategory-parent" class="form-select">
              <!-- Options will be populated by JavaScript -->
            </select>
          </div>
          <div class="form-group">
            <label for="subcategory-key" class="form-label">Subcategory Key</label>
            <input type="text" id="subcategory-key" class="form-input" placeholder="e.g. assault_rifles">
            <div class="form-help">This is used as the identifier in the JSON structure.</div>
          </div>
          <div class="form-group">
            <label for="subcategory-name" class="form-label">Subcategory Name</label>
            <input type="text" id="subcategory-name" class="form-input" placeholder="e.g. Assault Rifles">
            <div class="form-help">This is the display name shown to users.</div>
          </div>
          <div class="form-group">
            <button id="save-subcategory-button" class="button success">Save Subcategory</button>
            <button id="delete-subcategory-button" class="button danger">Delete Subcategory</button>
          </div>
        </div>

        <div id="item-editor" class="hidden">
          <div class="tabs">
            <div class="tab active" data-tab="basic-info">Basic Info</div>
            <div class="tab" data-tab="components">Components</div>
            <div class="tab" data-tab="materials">Materials</div>
            <div class="tab" data-tab="json">JSON</div>
          </div>

          <div id="basic-info-tab" class="tab-content active">
            <div class="form-group">
              <label for="item-parent" class="form-label">Parent Category</label>
              <select id="item-parent" class="form-select">
                <!-- Options will be populated by JavaScript -->
              </select>
            </div>
            <div class="form-group">
              <label for="item-id" class="form-label">Item ID</label>
              <input type="text" id="item-id" class="form-input" placeholder="e.g. sig-mcx">
              <div class="form-help">This is used as the identifier in the JSON structure.</div>
            </div>
            <div class="form-group">
              <label for="item-title" class="form-label">Item Title</label>
              <input type="text" id="item-title" class="form-input" placeholder="e.g. SIG MCX">
              <div class="form-help">This is the display name shown to users.</div>
            </div>
            <div class="form-group">
              <label for="item-quantity" class="form-label">Item Quantity</label>
              <input type="number" id="item-quantity" class="form-input" min="1" value="1">
            </div>
            <div class="form-group">
              <label for="item-image" class="form-label">Item Image URL</label>
              <input type="text" id="item-image" class="form-input" placeholder="https://example.com/image.png">
              <div class="form-help">URL to the image of the item.</div>
              <img id="item-image-preview" class="preview-image hidden" src="/placeholder.svg" alt="Item preview">
            </div>
          </div>

          <div id="components-tab" class="tab-content">
            <div id="component-list" class="component-list">
              <!-- Components will be populated by JavaScript -->
            </div>
            <button id="add-component-button" class="button add-component-button">Add Component</button>
          </div>

          <div id="materials-tab" class="tab-content">
            <div class="form-group">
              <label class="form-label">Total Materials</label>
              <div id="material-list" class="material-list">
                <!-- Materials will be populated by JavaScript -->
              </div>
              <button id="add-material-button" class="button add-material-button">Add Material</button>
            </div>
            <div class="form-group">
              <button id="calculate-materials-button" class="button">Calculate Total Materials</button>
              <div class="form-help">This will calculate the total materials based on the components.</div>
            </div>
          </div>

          <div id="json-tab" class="tab-content">
            <div class="form-group">
              <label for="item-json" class="form-label">Item JSON</label>
              <textarea id="item-json" class="json-editor" spellcheck="false"></textarea>
              <div class="form-help">Edit the raw JSON for this item. Be careful with the syntax!</div>
            </div>
            <div class="form-group">
              <button id="update-from-json-button" class="button">Update from JSON</button>
            </div>
          </div>

          <div class="form-group">
            <button id="save-item-button" class="button success">Save Item</button>
            <button id="delete-item-button" class="button danger">Delete Item</button>
          </div>
        </div>

        <div id="json-editor-screen" class="hidden">
          <div class="form-group">
            <label for="full-json" class="form-label">Full JSON</label>
            <textarea id="full-json" class="json-editor" spellcheck="false"></textarea>
            <div class="form-help">Edit the raw JSON for the entire crafting data. Be careful with the syntax!</div>
          </div>
          <div class="form-group">
            <button id="update-from-full-json-button" class="button">Update from JSON</button>
            <button id="copy-json-button" class="button">Copy</button>
          </div>
        </div>
      </div>
      <div class="editor-footer">
        <button id="view-json-button" class="button secondary">View Full JSON</button>
        <button id="back-button" class="button secondary hidden">Back to Editor</button>
      </div>
    </div>
  </div>

  <!-- Add Component Modal -->
  <div id="add-component-modal" class="modal-backdrop hidden">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Add Component</h3>
        <button class="modal-close" id="close-component-modal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="component-name" class="form-label">Component Name</label>
          <input type="text" id="component-name" class="form-input" placeholder="e.g. Weapon part">
        </div>
        <div class="form-group">
          <label for="component-quantity" class="form-label">Quantity</label>
          <input type="number" id="component-quantity" class="form-input" min="1" value="1">
        </div>
        <div class="form-group">
          <label class="form-label">Materials</label>
          <div id="component-material-list" class="material-list">
            <div class="material-item">
              <input type="text" class="form-input material-item-name" placeholder="Material name">
              <input type="number" class="form-input material-item-quantity" min="1" value="1">
              <button class="button small danger remove-material-button">Remove</button>
            </div>
          </div>
          <button id="add-component-material-button" class="button small add-material-button">Add Material</button>
        </div>
        <div class="form-group">
          <label class="form-label">Sub-Materials</label>
          <div id="component-submaterial-list" class="material-list">
            <!-- Sub-materials will be added dynamically -->
          </div>
          <button id="add-submaterial-group-button" class="button small add-material-button">Add Sub-Material Group</button>
        </div>
      </div>
      <div class="modal-footer">
        <button id="cancel-component-button" class="button secondary">Cancel</button>
        <button id="save-component-button" class="button success">Add Component</button>
      </div>
    </div>
  </div>

  <!-- Add Material Modal -->
  <div id="add-material-modal" class="modal-backdrop hidden">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Add Material</h3>
        <button class="modal-close" id="close-material-modal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="material-name" class="form-label">Material Name</label>
          <input type="text" id="material-name" class="form-input" placeholder="e.g. Iron ingot">
        </div>
        <div class="form-group">
          <label for="material-quantity" class="form-label">Quantity</label>
          <input type="number" id="material-quantity" class="form-input" min="1" value="1">
        </div>
      </div>
      <div class="modal-footer">
        <button id="cancel-material-button" class="button secondary">Cancel</button>
        <button id="save-material-button" class="button success">Add Material</button>
      </div>
    </div>
  </div>

  <!-- Add Sub-Material Group Modal -->
  <div id="add-submaterial-group-modal" class="modal-backdrop hidden">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Add Sub-Material Group</h3>
        <button class="modal-close" id="close-submaterial-group-modal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="submaterial-parent" class="form-label">Parent Material</label>
          <select id="submaterial-parent" class="form-select">
            <!-- Options will be populated by JavaScript -->
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Sub-Materials</label>
          <div id="submaterial-list" class="material-list">
            <div class="material-item">
              <input type="text" class="form-input material-item-name" placeholder="Material name">
              <input type="number" class="form-input material-item-quantity" min="1" value="1">
              <button class="button small danger remove-material-button">Remove</button>
            </div>
          </div>
          <button id="add-submaterial-button" class="button small add-material-button">Add Sub-Material</button>
        </div>
      </div>
      <div class="modal-footer">
        <button id="cancel-submaterial-group-button" class="button secondary">Cancel</button>
        <button id="save-submaterial-group-button" class="button success">Add Sub-Material Group</button>
      </div>
    </div>
  </div>

  <!-- Load from URL Modal -->
  <div id="load-url-modal" class="modal-backdrop hidden">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Load JSON from URL</h3>
        <button class="modal-close" id="close-url-modal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="json-url" class="form-label">JSON URL</label>
          <input type="text" id="json-url" class="form-input" placeholder="https://example.com/crafting-data.json">
          <div class="form-help">Enter the URL of your JSON file. Make sure the URL allows CORS.</div>
        </div>
        <div class="alert info">
          <p>For GitHub, use the raw URL format:</p>
          <p>https://raw.githubusercontent.com/username/repo/branch/path/to/file.json</p>
        </div>
      </div>
      <div class="modal-footer">
        <button id="cancel-url-button" class="button secondary">Cancel</button>
        <button id="fetch-url-button" class="button success">Load</button>
      </div>
    </div>
  </div>

  <script>
    // State
    let craftingData = {};
    let currentSelection = {
      type: null, // 'category', 'subcategory', 'item'
      categoryKey: null,
      subcategoryKey: null,
      itemId: null
    };
    let editingComponent = null;

    // DOM Elements
    const fileInputEl = document.getElementById('file-input');
    const loadButtonEl = document.getElementById('load-button');
    const saveButtonEl = document.getElementById('save-button');
    const createNewButtonEl = document.getElementById('create-new-button');
    const treeViewEl = document.getElementById('tree-view');
    const editorTitleEl = document.getElementById('editor-title');
    const welcomeScreenEl = document.getElementById('welcome-screen');
    const categoryEditorEl = document.getElementById('category-editor');
    const subcategoryEditorEl = document.getElementById('subcategory-editor');
    const itemEditorEl = document.getElementById('item-editor');
    const jsonEditorScreenEl = document.getElementById('json-editor-screen');
    const viewJsonButtonEl = document.getElementById('view-json-button');
    const backButtonEl = document.getElementById('back-button');
    
    // Category Editor Elements
    const categoryKeyEl = document.getElementById('category-key');
    const categoryNameEl = document.getElementById('category-name');
    const saveCategoryButtonEl = document.getElementById('save-category-button');
    const deleteCategoryButtonEl = document.getElementById('delete-category-button');
    const addCategoryButtonEl = document.getElementById('add-category-button');
    
    // Subcategory Editor Elements
    const subcategoryParentEl = document.getElementById('subcategory-parent');
    const subcategoryKeyEl = document.getElementById('subcategory-key');
    const subcategoryNameEl = document.getElementById('subcategory-name');
    const saveSubcategoryButtonEl = document.getElementById('save-subcategory-button');
    const deleteSubcategoryButtonEl = document.getElementById('delete-subcategory-button');
    const addSubcategoryButtonEl = document.getElementById('add-subcategory-button');
    
    // Item Editor Elements
    const itemParentEl = document.getElementById('item-parent');
    const itemIdEl = document.getElementById('item-id');
    const itemTitleEl = document.getElementById('item-title');
    const itemQuantityEl = document.getElementById('item-quantity');
    const itemImageEl = document.getElementById('item-image');
    const itemImagePreviewEl = document.getElementById('item-image-preview');
    const saveItemButtonEl = document.getElementById('save-item-button');
    const deleteItemButtonEl = document.getElementById('delete-item-button');
    const addItemButtonEl = document.getElementById('add-item-button');
    const componentListEl = document.getElementById('component-list');
    const addComponentButtonEl = document.getElementById('add-component-button');
    const materialListEl = document.getElementById('material-list');
    const addMaterialButtonEl = document.getElementById('add-material-button');
    const calculateMaterialsButtonEl = document.getElementById('calculate-materials-button');
    const itemJsonEl = document.getElementById('item-json');
    const updateFromJsonButtonEl = document.getElementById('update-from-json-button');
    
    // Full JSON Editor Elements
    const fullJsonEl = document.getElementById('full-json');
    const updateFromFullJsonButtonEl = document.getElementById('update-from-full-json-button');
    
    // Tab Elements
    const tabEls = document.querySelectorAll('.tab');
    const tabContentEls = document.querySelectorAll('.tab-content');
    
    // Component Modal Elements
    const addComponentModalEl = document.getElementById('add-component-modal');
    const closeComponentModalEl = document.getElementById('close-component-modal');
    const componentNameEl = document.getElementById('component-name');
    const componentQuantityEl = document.getElementById('component-quantity');
    const componentMaterialListEl = document.getElementById('component-material-list');
    const addComponentMaterialButtonEl = document.getElementById('add-component-material-button');
    const componentSubmaterialListEl = document.getElementById('component-submaterial-list');
    const addSubmaterialGroupButtonEl = document.getElementById('add-submaterial-group-button');
    const cancelComponentButtonEl = document.getElementById('cancel-component-button');
    const saveComponentButtonEl = document.getElementById('save-component-button');
    
    // Material Modal Elements
    const addMaterialModalEl = document.getElementById('add-material-modal');
    const closeMaterialModalEl = document.getElementById('close-material-modal');
    const materialNameEl = document.getElementById('material-name');
    const materialQuantityEl = document.getElementById('material-quantity');
    const cancelMaterialButtonEl = document.getElementById('cancel-material-button');
    const saveMaterialButtonEl = document.getElementById('save-material-button');
    
    // Sub-Material Group Modal Elements
    const addSubmaterialGroupModalEl = document.getElementById('add-submaterial-group-modal');
    const closeSubmaterialGroupModalEl = document.getElementById('close-submaterial-group-modal');
    const submaterialParentEl = document.getElementById('submaterial-parent');
    const submaterialListEl = document.getElementById('submaterial-list');
    const addSubmaterialButtonEl = document.getElementById('add-submaterial-button');
    const cancelSubmaterialGroupButtonEl = document.getElementById('cancel-submaterial-group-button');
    const saveSubmaterialGroupButtonEl = document.getElementById('save-submaterial-group-button');

    // Load from URL
    const loadUrlButtonEl = document.getElementById('load-url-button');
    const loadUrlModalEl = document.getElementById('load-url-modal');
    const closeUrlModalEl = document.getElementById('close-url-modal');
    const jsonUrlEl = document.getElementById('json-url');
    const cancelUrlButtonEl = document.getElementById('cancel-url-button');
    const fetchUrlButtonEl = document.getElementById('fetch-url-button');
    
    // Helper Functions
    function formatJSON(json) {
      return JSON.stringify(json, null, 2);
    }
    
    function parseJSON(jsonString) {
      try {
        return JSON.parse(jsonString);
      } catch (error) {
        alert('Invalid JSON: ' + error.message);
        return null;
      }
    }
    
    function showScreen(screen) {
      welcomeScreenEl.classList.add('hidden');
      categoryEditorEl.classList.add('hidden');
      subcategoryEditorEl.classList.add('hidden');
      itemEditorEl.classList.add('hidden');
      jsonEditorScreenEl.classList.add('hidden');
      
      screen.classList.remove('hidden');
      
      if (screen === jsonEditorScreenEl) {
        viewJsonButtonEl.classList.add('hidden');
        backButtonEl.classList.remove('hidden');
      } else {
        viewJsonButtonEl.classList.remove('hidden');
        backButtonEl.classList.add('hidden');
      }
    }
    
    function updateTreeView() {
      treeViewEl.innerHTML = '';
      
      // Create tree items for each category
      Object.entries(craftingData).forEach(([categoryKey, category], categoryIndex) => {
        const categoryEl = document.createElement('div');
        categoryEl.className = 'tree-item';
        
        const categoryHeaderEl = document.createElement('div');
        categoryHeaderEl.className = 'tree-item-header';
        if (currentSelection.type === 'category' && currentSelection.categoryKey === categoryKey) {
          categoryHeaderEl.classList.add('active');
        }
        
        categoryHeaderEl.innerHTML = `
          <div class="tree-item-header-content">
            <svg class="chevron-icon ${category.expanded ? 'expanded' : ''}" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
            ${category.name}
          </div>
          <div class="tree-item-actions">
            <div class="sort-buttons">
              <button class="sort-button move-up-button" data-category="${categoryKey}" data-index="${categoryIndex}" ${categoryIndex === 0 ? 'disabled' : ''}>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="18 15 12 9 6 15"></polyline>
                </svg>
              </button>
              <button class="sort-button move-down-button" data-category="${categoryKey}" data-index="${categoryIndex}" ${categoryIndex === Object.keys(craftingData).length - 1 ? 'disabled' : ''}>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
              </button>
            </div>
            <button class="button small add-subcategory-tree-button" data-category="${categoryKey}">+ Sub</button>
          </div>
        `;
        
        categoryHeaderEl.querySelector('.tree-item-header-content').addEventListener('click', () => {
          // Toggle expansion
          category.expanded = !category.expanded;
          
          // Select category
          selectCategory(categoryKey);
        });
        
        categoryEl.appendChild(categoryHeaderEl);
        
        // Add subcategories and items if expanded
        if (category.expanded) {
          const categoryContentEl = document.createElement('div');
          categoryContentEl.className = 'tree-item-content';
          
          // Add direct items if they exist
          if (category.items && Array.isArray(category.items)) {
            category.items.forEach((item, itemIndex) => {
              const itemEl = document.createElement('div');
              itemEl.className = 'tree-item-header';
              if (currentSelection.type === 'item' && currentSelection.categoryKey === categoryKey && 
                  currentSelection.subcategoryKey === null && currentSelection.itemId === item.id) {
                itemEl.classList.add('active');
              }
              
              itemEl.innerHTML = `
                <div class="tree-item-header-content">
                  ${item.title}
                </div>
                <div class="sort-buttons">
                  <button class="sort-button move-up-button" data-category="${categoryKey}" data-item-index="${itemIndex}" ${itemIndex === 0 ? 'disabled' : ''}>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <polyline points="18 15 12 9 6 15"></polyline>
                    </svg>
                  </button>
                  <button class="sort-button move-down-button" data-category="${categoryKey}" data-item-index="${itemIndex}" ${itemIndex === category.items.length - 1 ? 'disabled' : ''}>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                  </button>
                </div>
              `;
              
              itemEl.querySelector('.tree-item-header-content').addEventListener('click', () => {
                selectItem(categoryKey, null, item.id);
              });
              
              categoryContentEl.appendChild(itemEl);
            });
          }
          
          // Add subcategories
          if (category.subcategories) {
            Object.entries(category.subcategories).forEach(([subcategoryKey, subcategory], subcategoryIndex) => {
              const subcategoryEl = document.createElement('div');
              subcategoryEl.className = 'tree-item';
              
              const subcategoryHeaderEl = document.createElement('div');
              subcategoryHeaderEl.className = 'tree-item-header';
              if (currentSelection.type === 'subcategory' && currentSelection.categoryKey === categoryKey && 
                  currentSelection.subcategoryKey === subcategoryKey) {
                subcategoryHeaderEl.classList.add('active');
              }
              
              subcategoryHeaderEl.innerHTML = `
                <div class="tree-item-header-content">
                  <svg class="chevron-icon ${subcategory.expanded ? 'expanded' : ''}" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="9 18 15 12 9 6"></polyline>
                  </svg>
                  ${subcategory.name}
                </div>
                <div class="tree-item-actions">
                  <div class="sort-buttons">
                    <button class="sort-button move-up-button" data-category="${categoryKey}" data-subcategory-index="${subcategoryIndex}" ${subcategoryIndex === 0 ? 'disabled' : ''}>
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="18 15 12 9 6 15"></polyline>
                      </svg>
                    </button>
                    <button class="sort-button move-down-button" data-category="${categoryKey}" data-subcategory-index="${subcategoryIndex}" ${subcategoryIndex === Object.keys(category.subcategories).length - 1 ? 'disabled' : ''}>
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="6 9 12 15 18 9"></polyline>
                      </svg>
                    </button>
                  </div>
                  <button class="button small add-item-tree-button" data-category="${categoryKey}" data-subcategory="${subcategoryKey}">+ Item</button>
                </div>
              `;
              
              subcategoryHeaderEl.querySelector('.tree-item-header-content').addEventListener('click', () => {
                // Toggle expansion
                subcategory.expanded = !subcategory.expanded;
                
                // Select subcategory
                selectSubcategory(categoryKey, subcategoryKey);
              });
              
              subcategoryEl.appendChild(subcategoryHeaderEl);
              
              // Add items if expanded
              if (subcategory.expanded) {
                const subcategoryContentEl = document.createElement('div');
                subcategoryContentEl.className = 'tree-item-content';
                
                subcategory.items.forEach((item, itemIndex) => {
                  const itemEl = document.createElement('div');
                  itemEl.className = 'tree-item-header';
                  if (currentSelection.type === 'item' && currentSelection.categoryKey === categoryKey && 
                      currentSelection.subcategoryKey === subcategoryKey && currentSelection.itemId === item.id) {
                    itemEl.classList.add('active');
                  }
                  
                  itemEl.innerHTML = `
                    <div class="tree-item-header-content">
                      ${item.title}
                    </div>
                    <div class="sort-buttons">
                      <button class="sort-button move-up-button" data-category="${categoryKey}" data-subcategory="${subcategoryKey}" data-item-index="${itemIndex}" ${itemIndex === 0 ? 'disabled' : ''}>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <polyline points="18 15 12 9 6 15"></polyline>
                        </svg>
                      </button>
                      <button class="sort-button move-down-button" data-category="${categoryKey}" data-subcategory="${subcategoryKey}" data-item-index="${itemIndex}" ${itemIndex === subcategory.items.length - 1 ? 'disabled' : ''}>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                      </button>
                    </div>
                  `;
                  
                  itemEl.querySelector('.tree-item-header-content').addEventListener('click', () => {
                    selectItem(categoryKey, subcategoryKey, item.id);
                  });
                  
                  subcategoryContentEl.appendChild(itemEl);
                });
                
                subcategoryEl.appendChild(subcategoryContentEl);
              }
              
              categoryContentEl.appendChild(subcategoryEl);
            });
          }
          
          categoryEl.appendChild(categoryContentEl);
        }
        
        treeViewEl.appendChild(categoryEl);
      });
      
      // Add event listeners for tree buttons
      document.querySelectorAll('.add-subcategory-tree-button').forEach(button => {
        button.addEventListener('click', () => {
          const categoryKey = button.getAttribute('data-category');
          prepareAddSubcategory(categoryKey);
        });
      });
      
      document.querySelectorAll('.add-item-tree-button').forEach(button => {
        button.addEventListener('click', () => {
          const categoryKey = button.getAttribute('data-category');
          const subcategoryKey = button.getAttribute('data-subcategory');
          prepareAddItem(categoryKey, subcategoryKey);
        });
      });
      
      // Add event listeners for sort buttons
      document.querySelectorAll('.move-up-button, .move-down-button').forEach(button => {
        button.addEventListener('click', (e) => {
          e.stopPropagation();
          
          const direction = button.classList.contains('move-up-button') ? 'up' : 'down';
          const categoryKey = button.getAttribute('data-category');
          const subcategoryKey = button.getAttribute('data-subcategory');
          const itemIndex = button.getAttribute('data-item-index');
          const categoryIndex = button.getAttribute('data-index');
          const subcategoryIndex = button.getAttribute('data-subcategory-index');
          
          if (categoryIndex !== null && categoryIndex !== undefined) {
            moveCategory(categoryKey, direction);
          } else if (subcategoryIndex !== null && subcategoryIndex !== undefined) {
            moveSubcategory(categoryKey, subcategoryKey, direction);
          } else if (itemIndex !== null && itemIndex !== undefined) {
            moveItem(categoryKey, subcategoryKey, parseInt(itemIndex, 10), direction);
          }
        });
      });
    }

    // Füge diese Funktionen nach der updateTreeView-Funktion hinzu
    function moveCategory(categoryKey, direction) {
      // Get all category keys in order
      const categoryKeys = Object.keys(craftingData);
      const currentIndex = categoryKeys.indexOf(categoryKey);
      
      // Calculate new index
      let newIndex;
      if (direction === 'up') {
        if (currentIndex <= 0) return; // Already at the top
        newIndex = currentIndex - 1;
      } else {
        if (currentIndex >= categoryKeys.length - 1) return; // Already at the bottom
        newIndex = currentIndex + 1;
      }
      
      // Swap with adjacent category
      const adjacentKey = categoryKeys[newIndex];
      
      // Create a new object with the correct order
      const newCraftingData = {};
      
      categoryKeys.forEach((key, index) => {
        if (index === currentIndex) {
          // Skip, we'll add it in the new position
        } else if (index === newIndex) {
          if (direction === 'up') {
            newCraftingData[categoryKey] = craftingData[categoryKey];
            newCraftingData[adjacentKey] = craftingData[adjacentKey];
          } else {
            newCraftingData[adjacentKey] = craftingData[adjacentKey];
            newCraftingData[categoryKey] = craftingData[categoryKey];
          }
        } else {
          newCraftingData[key] = craftingData[key];
        }
      });
      
      // Update craftingData
      craftingData = newCraftingData;
      
      // Update UI
      updateTreeView();
    }

// Replace the moveSubcategory function with this improved version
function moveSubcategory(categoryKey, subcategoryKey, direction) {
  const category = craftingData[categoryKey];
  if (!category || !category.subcategories) return;
  
  // Get all subcategory keys in their current order
  const subcategoryKeys = Object.keys(category.subcategories);
  const currentIndex = subcategoryKeys.indexOf(subcategoryKey);
  
  if (currentIndex === -1) return; // Subcategory not found
  
  // Calculate new index
  let newIndex;
  if (direction === 'up') {
    if (currentIndex <= 0) return; // Already at the top
    newIndex = currentIndex - 1;
  } else {
    if (currentIndex >= subcategoryKeys.length - 1) return; // Already at the bottom
    newIndex = currentIndex + 1;
  }
  
  // Get the key to swap with
  const swapKey = subcategoryKeys[newIndex];
  
  // Create a completely new subcategories object to ensure proper order
  const newSubcategories = {};
  
  // Add all subcategories in the correct order
  subcategoryKeys.forEach((key, index) => {
    // Skip the keys we're moving - we'll add them in the correct order
    if (key !== subcategoryKey && key !== swapKey) {
      newSubcategories[key] = category.subcategories[key];
    }
  });
  
  // Now add the swapped subcategories in the correct order
  if (direction === 'up') {
    // Current subcategory moves up (before the swap subcategory)
    newSubcategories[subcategoryKey] = category.subcategories[subcategoryKey];
    newSubcategories[swapKey] = category.subcategories[swapKey];
  } else {
    // Current subcategory moves down (after the swap subcategory)
    newSubcategories[swapKey] = category.subcategories[swapKey];
    newSubcategories[subcategoryKey] = category.subcategories[subcategoryKey];
  }
  
  // Create the final subcategories object with the correct order
  const finalSubcategories = {};
  
  // Add all subcategories in the correct order
  subcategoryKeys.forEach((key, index) => {
    if (index === currentIndex) {
      // Skip, we'll add it in the new position
    } else if (index === newIndex) {
      if (direction === 'up') {
        finalSubcategories[subcategoryKey] = category.subcategories[subcategoryKey];
        finalSubcategories[swapKey] = category.subcategories[swapKey];
      } else {
        finalSubcategories[swapKey] = category.subcategories[swapKey];
        finalSubcategories[subcategoryKey] = category.subcategories[subcategoryKey];
      }
    } else {
      finalSubcategories[key] = category.subcategories[key];
    }
  });
  
  // Replace the subcategories object
  category.subcategories = finalSubcategories;
  
  // Update UI
  updateTreeView();
}

// Replace the moveItem function with this improved version
function moveItem(categoryKey, subcategoryKey, itemIndex, direction) {
  let items;
  
  if (subcategoryKey) {
    // Get items from subcategory
    items = craftingData[categoryKey].subcategories[subcategoryKey].items;
  } else {
    // Get items from category
    items = craftingData[categoryKey].items;
  }
  
  if (!items || !Array.isArray(items)) {
    console.error("Items array not found or not an array");
    return;
  }
  
  // Calculate new index
  let newIndex;
  if (direction === 'up') {
    if (itemIndex <= 0) return; // Already at the top
    newIndex = itemIndex - 1;
  } else {
    if (itemIndex >= items.length - 1) return; // Already at the bottom
    newIndex = itemIndex + 1;
  }
  
  // Create a copy of the items array
  const newItems = [...items];
  
  // Get the items to swap
  const currentItem = newItems[itemIndex];
  const swapItem = newItems[newIndex];
  
  // Swap the items
  newItems[itemIndex] = swapItem;
  newItems[newIndex] = currentItem;
  
  // Update the items array
  if (subcategoryKey) {
    craftingData[categoryKey].subcategories[subcategoryKey].items = newItems;
  } else {
    craftingData[categoryKey].items = newItems;
  }
  
  // Update UI
  updateTreeView();
}
    
    function selectCategory(categoryKey) {
      currentSelection = {
        type: 'category',
        categoryKey,
        subcategoryKey: null,
        itemId: null
      };
      
      updateTreeView();
      
      // Populate category editor
      const category = craftingData[categoryKey];
      categoryKeyEl.value = categoryKey;
      categoryNameEl.value = category.name;
      
      editorTitleEl.textContent = `Editing Category: ${category.name}`;
      showScreen(categoryEditorEl);
    }
    
    function selectSubcategory(categoryKey, subcategoryKey) {
      currentSelection = {
        type: 'subcategory',
        categoryKey,
        subcategoryKey,
        itemId: null
      };
      
      updateTreeView();
      
      // Populate subcategory editor
      const subcategory = craftingData[categoryKey].subcategories[subcategoryKey];
      
      // Populate parent category dropdown
      subcategoryParentEl.innerHTML = '';
      Object.entries(craftingData).forEach(([key, category]) => {
        const option = document.createElement('option');
        option.value = key;
        option.textContent = category.name;
        option.selected = key === categoryKey;
        subcategoryParentEl.appendChild(option);
      });
      
      subcategoryKeyEl.value = subcategoryKey;
      subcategoryNameEl.value = subcategory.name;
      
      editorTitleEl.textContent = `Editing Subcategory: ${subcategory.name}`;
      showScreen(subcategoryEditorEl);
    }
    
    function selectItem(categoryKey, subcategoryKey, itemId) {
      currentSelection = {
        type: 'item',
        categoryKey,
        subcategoryKey,
        itemId
      };
      
      updateTreeView();
      
      // Find the item
      let item;
      let itemParent;
      
      if (subcategoryKey) {
        itemParent = craftingData[categoryKey].subcategories[subcategoryKey];
        item = itemParent.items.find(i => i.id === itemId);
      } else {
        itemParent = craftingData[categoryKey];
        item = itemParent.items.find(i => i.id === itemId);
      }
      
      // Populate item editor
      
      // Populate parent dropdown
      itemParentEl.innerHTML = '';
      
      // Add categories with direct items
      Object.entries(craftingData).forEach(([key, category]) => {
        if (category.items) {
          const option = document.createElement('option');
          option.value = `${key}`;
          option.textContent = category.name;
          option.selected = key === categoryKey && subcategoryKey === null;
          itemParentEl.appendChild(option);
        }
      });
      
      // Add subcategories
      Object.entries(craftingData).forEach(([catKey, category]) => {
        if (category.subcategories) {
          Object.entries(category.subcategories).forEach(([subKey, subcategory]) => {
            const option = document.createElement('option');
            option.value = `${catKey}:${subKey}`;
            option.textContent = `${category.name} > ${subcategory.name}`;
            option.selected = catKey === categoryKey && subKey === subcategoryKey;
            itemParentEl.appendChild(option);
          });
        }
      });
      
      itemIdEl.value = item.id;
      itemTitleEl.value = item.title;
      itemQuantityEl.value = item.quantity;
      itemImageEl.value = item.imageUrl || '';
      
      if (item.imageUrl) {
        itemImagePreviewEl.src = item.imageUrl;
        itemImagePreviewEl.classList.remove('hidden');
      } else {
        itemImagePreviewEl.classList.add('hidden');
      }
      
      // Populate components
      updateComponentList(item.items || []);
      
      // Populate materials
      updateMaterialList(item.totalMaterials || []);
      
      // Update JSON
      itemJsonEl.value = formatJSON(item);
      
      editorTitleEl.textContent = `Editing Item: ${item.title}`;
      showScreen(itemEditorEl);
      
      // Reset to first tab
      tabEls[0].click();
    }
    
    function updateComponentList(components) {
  componentListEl.innerHTML = '';
  
  components.forEach((component, index) => {
    const componentEl = document.createElement('div');
    componentEl.className = 'component-item';
    
    let componentHTML = `
      <div class="component-header">
        <span class="component-name">${component.name}</span>
        <input type="number" class="form-input component-quantity" value="${component.quantity}" min="1" readonly>
        <button class="button small edit-component-button" data-index="${index}">Edit</button>
        <button class="button small danger remove-component-button" data-index="${index}">Remove</button>
      </div>
      <div class="component-materials">
        <strong>Materials:</strong>
        <div class="material-table">
    `;
    
    // Verbesserte Darstellung der Materialien als Tabelle
    if (component.materials && component.materials.length > 0) {
      componentHTML += `
        <table class="materials-table">
          <thead>
            <tr>
              <th>Material</th>
              <th>Quantity</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      component.materials.forEach(material => {
        componentHTML += `
          <tr>
            <td>${material.name}</td>
            <td class="text-center">${material.quantity}</td>
          </tr>
        `;
      });
      
      componentHTML += `
          </tbody>
        </table>
      `;
    } else {
      componentHTML += `<p>No materials defined</p>`;
    }
    
    componentHTML += `</div></div>`;
    
    // Verbesserte Darstellung der Submaterialien
    if (component.subMaterials) {
      componentHTML += `<div class="component-submaterials"><strong>Sub-Materials:</strong>`;
      
      Object.entries(component.subMaterials).forEach(([materialName, subMaterials]) => {
        componentHTML += `
          <div class="submaterial-group">
            <h4>${materialName}:</h4>
            <table class="materials-table">
              <thead>
                <tr>
                  <th>Material</th>
                  <th>Quantity</th>
                </tr>
              </thead>
              <tbody>
        `;
        
        subMaterials.forEach(subMaterial => {
          componentHTML += `
            <tr>
              <td>${subMaterial.name}</td>
              <td class="text-center">${subMaterial.quantity}</td>
            </tr>
          `;
        });
        
        componentHTML += `
              </tbody>
            </table>
          </div>
        `;
      });
      
      componentHTML += `</div>`;
    }
    
    componentEl.innerHTML = componentHTML;
    
    // Add event listeners
    componentEl.querySelector('.edit-component-button').addEventListener('click', () => {
      editComponent(index);
    });
    
    componentEl.querySelector('.remove-component-button').addEventListener('click', () => {
      removeComponent(index);
    });
    
    componentListEl.appendChild(componentEl);
  });
}
    
    function updateMaterialList(materials) {
      materialListEl.innerHTML = '';
      
      materials.forEach((material, index) => {
        const materialEl = document.createElement('div');
        materialEl.className = 'material-item';
        materialEl.innerHTML = `
          <span class="material-item-name">${material.name}</span>
          <input type="number" class="form-input material-item-quantity" value="${material.quantity}" min="1" readonly>
          <button class="button small edit-material-button" data-index="${index}">Edit</button>
          <button class="button small danger remove-material-button" data-index="${index}">Remove</button>
        `;
        
        // Add event listeners
        materialEl.querySelector('.edit-material-button').addEventListener('click', () => {
          editMaterial(index);
        });
        
        materialEl.querySelector('.remove-material-button').addEventListener('click', () => {
          removeMaterial(index);
        });
        
        materialListEl.appendChild(materialEl);
      });
    }
    
    function prepareAddCategory() {
      currentSelection = {
        type: 'category',
        categoryKey: null,
        subcategoryKey: null,
        itemId: null
      };
      
      categoryKeyEl.value = '';
      categoryNameEl.value = '';
      
      editorTitleEl.textContent = 'Add New Category';
      showScreen(categoryEditorEl);
    }
    
    function prepareAddSubcategory(categoryKey) {
      currentSelection = {
        type: 'subcategory',
        categoryKey,
        subcategoryKey: null,
        itemId: null
      };
      
      // Populate parent category dropdown
      subcategoryParentEl.innerHTML = '';
      Object.entries(craftingData).forEach(([key, category]) => {
        const option = document.createElement('option');
        option.value = key;
        option.textContent = category.name;
        option.selected = key === categoryKey;
        subcategoryParentEl.appendChild(option);
      });
      
      subcategoryKeyEl.value = '';
      subcategoryNameEl.value = '';
      
      editorTitleEl.textContent = 'Add New Subcategory';
      showScreen(subcategoryEditorEl);
    }
    
    function prepareAddItem(categoryKey, subcategoryKey) {
      currentSelection = {
        type: 'item',
        categoryKey,
        subcategoryKey,
        itemId: null
      };
      
      // Populate parent dropdown
      itemParentEl.innerHTML = '';
      
      // Add categories with direct items
      Object.entries(craftingData).forEach(([key, category]) => {
        if (category.items) {
          const option = document.createElement('option');
          option.value = `${key}`;
          option.textContent = category.name;
          option.selected = key === categoryKey && subcategoryKey === null;
          itemParentEl.appendChild(option);
        }
      });
      
      // Add subcategories
      Object.entries(craftingData).forEach(([catKey, category]) => {
        if (category.subcategories) {
          Object.entries(category.subcategories).forEach(([subKey, subcategory]) => {
            const option = document.createElement('option');
            option.value = `${catKey}:${subKey}`;
            option.textContent = `${category.name} > ${subcategory.name}`;
            option.selected = catKey === categoryKey && subKey === subcategoryKey;
            itemParentEl.appendChild(option);
          });
        }
      });
      
      itemIdEl.value = '';
      itemTitleEl.value = '';
      itemQuantityEl.value = '1';
      itemImageEl.value = '';
      itemImagePreviewEl.classList.add('hidden');
      
      // Clear components and materials
      updateComponentList([]);
      updateMaterialList([]);
      
      // Clear JSON
      itemJsonEl.value = formatJSON({
        id: '',
        title: '',
        quantity: 1,
        items: [],
        totalMaterials: [],
        imageUrl: ''
      });
      
      editorTitleEl.textContent = 'Add New Item';
      showScreen(itemEditorEl);
      
      // Reset to first tab
      tabEls[0].click();
    }
    
    function saveCategory() {
      const key = categoryKeyEl.value.trim();
      const name = categoryNameEl.value.trim();
      
      if (!key) {
        alert('Category key is required');
        return;
      }
      
      if (!name) {
        alert('Category name is required');
        return;
      }
      
      // Check if adding new category
      if (currentSelection.categoryKey === null) {
        // Check if key already exists
        if (craftingData[key]) {
          alert('Category key already exists');
          return;
        }
        
        // Add new category
        craftingData[key] = {
          name,
          expanded: true,
          items: [],
          subcategories: {}
        };
        
        currentSelection.categoryKey = key;
      } else {
        // Update existing category
        const oldKey = currentSelection.categoryKey;
        
        if (oldKey !== key) {
          // Key changed, need to move the category
          if (craftingData[key]) {
            alert('Category key already exists');
            return;
          }
          
          // Create new category with new key
          craftingData[key] = {
            ...craftingData[oldKey],
            name
          };
          
          // Delete old category
          delete craftingData[oldKey];
          
          currentSelection.categoryKey = key;
        } else {
          // Just update the name
          craftingData[key].name = name;
        }
      }
      
      updateTreeView();
      alert('Category saved successfully');
    }
    
    function deleteCategory() {
      if (!currentSelection.categoryKey) {
        return;
      }
      
      if (!confirm(`Are you sure you want to delete the category "${craftingData[currentSelection.categoryKey].name}"?`)) {
        return;
      }
      
      delete craftingData[currentSelection.categoryKey];
      
      currentSelection = {
        type: null,
        categoryKey: null,
        subcategoryKey: null,
        itemId: null
      };
      
      updateTreeView();
      showScreen(welcomeScreenEl);
      alert('Category deleted successfully');
    }
    
    function saveSubcategory() {
      const parentKey = subcategoryParentEl.value;
      const key = subcategoryKeyEl.value.trim();
      const name = subcategoryNameEl.value.trim();
      
      if (!parentKey) {
        alert('Parent category is required');
        return;
      }
      
      if (!key) {
        alert('Subcategory key is required');
        return;
      }
      
      if (!name) {
        alert('Subcategory name is required');
        return;
      }
      
      // Ensure parent category has subcategories object
      if (!craftingData[parentKey].subcategories) {
        craftingData[parentKey].subcategories = {};
      }
      
      // Check if adding new subcategory
      if (currentSelection.subcategoryKey === null) {
        // Check if key already exists
        if (craftingData[parentKey].subcategories[key]) {
          alert('Subcategory key already exists in this category');
          return;
        }
        
        // Add new subcategory
        craftingData[parentKey].subcategories[key] = {
          name,
          expanded: true,
          items: []
        };
        
        currentSelection.categoryKey = parentKey;
        currentSelection.subcategoryKey = key;
      } else {
        // Update existing subcategory
        const oldCategoryKey = currentSelection.categoryKey;
        const oldKey = currentSelection.subcategoryKey;
        
        if (oldCategoryKey !== parentKey || oldKey !== key) {
          // Key or parent changed, need to move the subcategory
          if (craftingData[parentKey].subcategories[key]) {
            alert('Subcategory key already exists in this category');
            return;
          }
          
          // Create new subcategory with new key
          craftingData[parentKey].subcategories[key] = {
            ...craftingData[oldCategoryKey].subcategories[oldKey],
            name
          };
          
          // Delete old subcategory
          delete craftingData[oldCategoryKey].subcategories[oldKey];
          
          currentSelection.categoryKey = parentKey;
          currentSelection.subcategoryKey = key;
        } else {
          // Just update the name
          craftingData[parentKey].subcategories[key].name = name;
        }
      }
      
      updateTreeView();
      alert('Subcategory saved successfully');
    }
    
    function deleteSubcategory() {
      if (!currentSelection.categoryKey || !currentSelection.subcategoryKey) {
        return;
      }
      
      const subcategory = craftingData[currentSelection.categoryKey].subcategories[currentSelection.subcategoryKey];
      
      if (!confirm(`Are you sure you want to delete the subcategory "${subcategory.name}"?`)) {
        return;
      }
      
      delete craftingData[currentSelection.categoryKey].subcategories[currentSelection.subcategoryKey];
      
      currentSelection = {
        type: 'category',
        categoryKey: currentSelection.categoryKey,
        subcategoryKey: null,
        itemId: null
      };
      
      updateTreeView();
      selectCategory(currentSelection.categoryKey);
      alert('Subcategory deleted successfully');
    }
    
    function saveItem() {
      const parentValue = itemParentEl.value;
      const id = itemIdEl.value.trim();
      const title = itemTitleEl.value.trim();
      const quantity = parseInt(itemQuantityEl.value, 10);
      const imageUrl = itemImageEl.value.trim();
      
      if (!parentValue) {
        alert('Parent category or subcategory is required');
        return;
      }
      
      if (!id) {
        alert('Item ID is required');
        return;
      }
      
      if (!title) {
        alert('Item title is required');
        return;
      }
      
      // Parse parent value to get category and subcategory
      let categoryKey, subcategoryKey;
      if (parentValue.includes(':')) {
        [categoryKey, subcategoryKey] = parentValue.split(':');
      } else {
        categoryKey = parentValue;
        subcategoryKey = null;
      }
      
      // Get components and materials from the UI
      let components = [];
      let materials = [];
      
      // Get components from the component list
      document.querySelectorAll('.component-item').forEach(componentEl => {
        const name = componentEl.querySelector('.component-name').textContent;
        const quantity = parseInt(componentEl.querySelector('.component-quantity').value, 10);
        
        // Parse materials from the HTML
        const materialsEl = componentEl.querySelector('.component-materials ul');
        const materials = Array.from(materialsEl.querySelectorAll('li')).map(li => {
          const [name, quantityStr] = li.textContent.split(': ');
          return {
            name,
            quantity: parseInt(quantityStr, 10)
          };
        });
        
        // Parse submaterials if they exist
        let subMaterials = null;
        const subMaterialsEl = componentEl.querySelector('.component-submaterials');
        if (subMaterialsEl) {
          subMaterials = {};
          
          Array.from(subMaterialsEl.querySelectorAll('> ul > li')).forEach(li => {
            const materialName = li.textContent.split(':')[0];
            subMaterials[materialName] = [];
            
            Array.from(li.querySelectorAll('ul > li')).forEach(subLi => {
              const [name, quantityStr] = subLi.textContent.split(': ');
              subMaterials[materialName].push({
                name,
                quantity: parseInt(quantityStr, 10)
              });
            });
          });
        }
        
        components.push({
          name,
          quantity,
          materials,
          ...(subMaterials ? { subMaterials } : {})
        });
      });
      
      // Get materials from the material list
      document.querySelectorAll('#material-list .material-item').forEach(materialEl => {
        const name = materialEl.querySelector('.material-item-name').textContent;
        const quantity = parseInt(materialEl.querySelector('.material-item-quantity').value, 10);
        
        materials.push({
          name,
          quantity
        });
      });
      
      // Create item object
      const item = {
        id,
        title,
        quantity,
        items: components,
        totalMaterials: materials,
        ...(imageUrl ? { imageUrl } : {})
      };
      
      // Check if adding new item or updating existing
      if (currentSelection.itemId === null) {
        // Adding new item
        
        // Check if ID already exists
        let itemExists = false;
        
        if (subcategoryKey) {
          itemExists = craftingData[categoryKey].subcategories[subcategoryKey].items.some(i => i.id === id);
        } else {
          itemExists = craftingData[categoryKey].items.some(i => i.id === id);
        }
        
        if (itemExists) {
          alert('Item ID already exists in this category or subcategory');
          return;
        }
        
        // Add new item
        if (subcategoryKey) {
          craftingData[categoryKey].subcategories[subcategoryKey].items.push(item);
        } else {
          if (!craftingData[categoryKey].items) {
            craftingData[categoryKey].items = [];
          }
          craftingData[categoryKey].items.push(item);
        }
        
        currentSelection.categoryKey = categoryKey;
        currentSelection.subcategoryKey = subcategoryKey;
        currentSelection.itemId = id;
      } else {
        // Updating existing item
        const oldCategoryKey = currentSelection.categoryKey;
        const oldSubcategoryKey = currentSelection.subcategoryKey;
        const oldId = currentSelection.itemId;
        
        // Check if moving to a different parent or changing ID
        if (oldCategoryKey !== categoryKey || oldSubcategoryKey !== subcategoryKey || oldId !== id) {
          // Check if new ID already exists in new parent
          let itemExists = false;
          
          if (subcategoryKey) {
            itemExists = craftingData[categoryKey].subcategories[subcategoryKey].items.some(i => i.id === id);
          } else {
            itemExists = craftingData[categoryKey].items.some(i => i.id === id);
          }
          
          if (itemExists) {
            alert('Item ID already exists in the target category or subcategory');
            return;
          }
          
          // Remove from old parent
          if (oldSubcategoryKey) {
            craftingData[oldCategoryKey].subcategories[oldSubcategoryKey].items = 
              craftingData[oldCategoryKey].subcategories[oldSubcategoryKey].items.filter(i => i.id !== oldId);
          } else {
            craftingData[oldCategoryKey].items = 
              craftingData[oldCategoryKey].items.filter(i => i.id !== oldId);
          }
          
          // Add to new parent
          if (subcategoryKey) {
            craftingData[categoryKey].subcategories[subcategoryKey].items.push(item);
          } else {
            if (!craftingData[categoryKey].items) {
              craftingData[categoryKey].items = [];
            }
            craftingData[categoryKey].items.push(item);
          }
          
          currentSelection.categoryKey = categoryKey;
          currentSelection.subcategoryKey = subcategoryKey;
          currentSelection.itemId = id;
        } else {
          // Just update the item in place
          if (subcategoryKey) {
            const index = craftingData[categoryKey].subcategories[subcategoryKey].items.findIndex(i => i.id === id);
            craftingData[categoryKey].subcategories[subcategoryKey].items[index] = item;
          } else {
            const index = craftingData[categoryKey].items.findIndex(i => i.id === id);
            craftingData[categoryKey].items[index] = item;
          }
        }
      }
      
      updateTreeView();
      alert('Item saved successfully');
    }
    
    function deleteItem() {
      if (!currentSelection.categoryKey || !currentSelection.itemId) {
        return;
      }
      
      let item;
      
      if (currentSelection.subcategoryKey) {
        item = craftingData[currentSelection.categoryKey].subcategories[currentSelection.subcategoryKey].items
          .find(i => i.id === currentSelection.itemId);
      } else {
        item = craftingData[currentSelection.categoryKey].items
          .find(i => i.id === currentSelection.itemId);
      }
      
      if (!confirm(`Are you sure you want to delete the item "${item.title}"?`)) {
        return;
      }
      
      if (currentSelection.subcategoryKey) {
        craftingData[currentSelection.categoryKey].subcategories[currentSelection.subcategoryKey].items = 
          craftingData[currentSelection.categoryKey].subcategories[currentSelection.subcategoryKey].items
            .filter(i => i.id !== currentSelection.itemId);
            
        currentSelection = {
          type: 'subcategory',
          categoryKey: currentSelection.categoryKey,
          subcategoryKey: currentSelection.subcategoryKey,
          itemId: null
        };
        
        updateTreeView();
        selectSubcategory(currentSelection.categoryKey, currentSelection.subcategoryKey);
      } else {
        craftingData[currentSelection.categoryKey].items = 
          craftingData[currentSelection.categoryKey].items
            .filter(i => i.id !== currentSelection.itemId);
            
        currentSelection = {
          type: 'category',
          categoryKey: currentSelection.categoryKey,
          subcategoryKey: null,
          itemId: null
        };
        
        updateTreeView();
        selectCategory(currentSelection.categoryKey);
      }
      
      alert('Item deleted successfully');
    }
    
    function addComponent() {
      // Reset component modal
      componentNameEl.value = '';
      componentQuantityEl.value = '1';
      componentMaterialListEl.innerHTML = `
        <div class="material-item">
          <input type="text" class="form-input material-item-name" placeholder="Material name">
          <input type="number" class="form-input material-item-quantity" min="1" value="1">
          <button class="button small danger remove-material-button">Remove</button>
        </div>
      `;
      componentSubmaterialListEl.innerHTML = '';
      
      // Show modal
      addComponentModalEl.classList.remove('hidden');
      
      // Set editing component to null to indicate adding new
      editingComponent = null;
    }
    
    function editComponent(index) {
      // Get the component
      let component;
      
      if (currentSelection.subcategoryKey) {
        component = craftingData[currentSelection.categoryKey].subcategories[currentSelection.subcategoryKey].items
          .find(i => i.id === currentSelection.itemId).items[index];
      } else {
        component = craftingData[currentSelection.categoryKey].items
          .find(i => i.id === currentSelection.itemId).items[index];
      }
      
      // Populate component modal
      componentNameEl.value = component.name;
      componentQuantityEl.value = component.quantity;
      
      // Populate materials
      componentMaterialListEl.innerHTML = '';
      
      component.materials.forEach(material => {
        const materialEl = document.createElement('div');
        materialEl.className = 'material-item';
        materialEl.innerHTML = `
          <input type="text" class="form-input material-item-name" placeholder="Material name" value="${material.name}">
          <input type="number" class="form-input material-item-quantity" min="1" value="${material.quantity}">
          <button class="button small danger remove-material-button">Remove</button>
        `;
        
        materialEl.querySelector('.remove-material-button').addEventListener('click', function() {
          this.closest('.material-item').remove();
        });
        
        componentMaterialListEl.appendChild(materialEl);
      });
      
      // Populate submaterials
      componentSubmaterialListEl.innerHTML = '';
      
      if (component.subMaterials) {
        Object.entries(component.subMaterials).forEach(([materialName, subMaterials]) => {
          const submaterialGroupEl = document.createElement('div');
          submaterialGroupEl.className = 'submaterial-group';
          submaterialGroupEl.innerHTML = `
            <div class="form-group">
              <label class="form-label">Sub-Materials for ${materialName}</label>
              <div class="material-list">
                ${subMaterials.map(subMaterial => `
                  <div class="material-item" data-parent="${materialName}">
                    <input type="text" class="form-input material-item-name" placeholder="Material name" value="${subMaterial.name}">
                    <input type="number" class="form-input material-item-quantity" min="1" value="${subMaterial.quantity}">
                    <button class="button small danger remove-material-button">Remove</button>
                  </div>
                `).join('')}
              </div>
              <button class="button small add-submaterial-button" data-parent="${materialName}">Add Sub-Material</button>
              <button class="button small danger remove-submaterial-group-button" data-parent="${materialName}">Remove Group</button>
            </div>
          `;
          
          // Add event listeners
          submaterialGroupEl.querySelectorAll('.remove-material-button').forEach(button => {
            button.addEventListener('click', function() {
              this.closest('.material-item').remove();
            });
          });
          
          submaterialGroupEl.querySelector('.add-submaterial-button').addEventListener('click', function() {
            const parentMaterial = this.getAttribute('data-parent');
            const materialList = this.previousElementSibling;
            
            const materialEl = document.createElement('div');
            materialEl.className = 'material-item';
            materialEl.setAttribute('data-parent', parentMaterial);
            materialEl.innerHTML = `
              <input type="text" class="form-input material-item-name" placeholder="Material name">
              <input type="number" class="form-input material-item-quantity" min="1" value="1">
              <button class="button small danger remove-material-button">Remove</button>
            `;
            
            materialEl.querySelector('.remove-material-button').addEventListener('click', function() {
              this.closest('.material-item').remove();
            });
            
            materialList.appendChild(materialEl);
          });
          
          submaterialGroupEl.querySelector('.remove-submaterial-group-button').addEventListener('click', function() {
            this.closest('.submaterial-group').remove();
          });
          
          componentSubmaterialListEl.appendChild(submaterialGroupEl);
        });
      }
      
      // Show modal
      addComponentModalEl.classList.remove('hidden');
      
      // Set editing component index
      editingComponent = index;
    }
    
    function saveComponent() {
      // Get component data from modal
      const name = componentNameEl.value.trim();
      const quantity = parseInt(componentQuantityEl.value, 10);
      
      if (!name) {
        alert('Component name is required');
        return;
      }
      
      // Get materials
      const materials = [];
      
      componentMaterialListEl.querySelectorAll('.material-item').forEach(materialEl => {
        const materialName = materialEl.querySelector('.material-item-name').value.trim();
        const materialQuantity = parseInt(materialEl.querySelector('.material-item-quantity').value, 10);
        
        if (materialName) {
          materials.push({
            name: materialName,
            quantity: materialQuantity
          });
        }
      });
      
      if (materials.length === 0) {
        alert('At least one material is required');
        return;
      }
      
      // Get submaterials
      let subMaterials = null;
      
      const submaterialGroups = componentSubmaterialListEl.querySelectorAll('.submaterial-group');
      if (submaterialGroups.length > 0) {
        subMaterials = {};
        
        submaterialGroups.forEach(groupEl => {
          const items = groupEl.querySelectorAll('.material-item');
          if (items.length > 0) {
            const parentMaterial = items[0].getAttribute('data-parent');
            subMaterials[parentMaterial] = [];
            
            items.forEach(itemEl => {
              const subMaterialName = itemEl.querySelector('.material-item-name').value.trim();
              const subMaterialQuantity = parseInt(itemEl.querySelector('.material-item-quantity').value, 10);
              
              if (subMaterialName) {
                subMaterials[parentMaterial].push({
                  name: subMaterialName,
                  quantity: subMaterialQuantity // Hier war der Fehler: materialQuantity statt subMaterialQuantity
                });
              }
            });
            
            // Remove empty arrays
            if (subMaterials[parentMaterial].length === 0) {
              delete subMaterials[parentMaterial];
            }
          }
        });
        
        // If no submaterials, set to null
        if (Object.keys(subMaterials).length === 0) {
          subMaterials = null;
        }
      }
      
      // Create component object
      const component = {
        name,
        quantity,
        materials,
        ...(subMaterials ? { subMaterials } : {})
      };
      
      // Get current item
      let item;
      
      if (currentSelection.subcategoryKey) {
        item = craftingData[currentSelection.categoryKey].subcategories[currentSelection.subcategoryKey].items
          .find(i => i.id === currentSelection.itemId);
      } else {
        item = craftingData[currentSelection.categoryKey].items
          .find(i => i.id === currentSelection.itemId);
      }
      
      // Add or update component
      if (editingComponent === null) {
        // Add new component
        if (!item.items) {
          item.items = [];
        }
        
        item.items.push(component);
      } else {
        // Update existing component
        item.items[editingComponent] = component;
      }
      
      // Update component list
      updateComponentList(item.items);
      
      // Update JSON
      itemJsonEl.value = formatJSON(item);
      
      // Hide modal
      addComponentModalEl.classList.add('hidden');
    }
    
    function removeComponent(index) {
      if (!confirm('Are you sure you want to remove this component?')) {
        return;
      }
      
      // Get current item
      let item;
      
      if (currentSelection.subcategoryKey) {
        item = craftingData[currentSelection.categoryKey].subcategories[currentSelection.subcategoryKey].items
          .find(i => i.id === currentSelection.itemId);
      } else {
        item = craftingData[currentSelection.categoryKey].items
          .find(i => i.id === currentSelection.itemId);
      }
      
      // Remove component
      item.items.splice(index, 1);
      
      // Update component list
      updateComponentList(item.items);
      
      // Update JSON
      itemJsonEl.value = formatJSON(item);
    }
    
    function addMaterial() {
      // Reset material modal
      materialNameEl.value = '';
      materialQuantityEl.value = '1';
      
      // Show modal
      addMaterialModalEl.classList.remove('hidden');
    }
    
    function editMaterial(index) {
      // Get the material
      let material;
      
      if (currentSelection.subcategoryKey) {
        material = craftingData[currentSelection.categoryKey].subcategories[currentSelection.subcategoryKey].items
          .find(i => i.id === currentSelection.itemId).totalMaterials[index];
      } else {
        material = craftingData[currentSelection.categoryKey].items
          .find(i => i.id === currentSelection.itemId).totalMaterials[index];
      }
      
      // Populate material modal
      materialNameEl.value = material.name;
      materialQuantityEl.value = material.quantity;
      
      // Show modal
      addMaterialModalEl.classList.remove('hidden');
      
      // Store index in save button
      saveMaterialButtonEl.setAttribute('data-index', index);
    }
    
    function saveMaterial() {
      // Get material data from modal
      const name = materialNameEl.value.trim();
      const quantity = parseInt(materialQuantityEl.value, 10);
      
      if (!name) {
        alert('Material name is required');
        return;
      }
      
      // Create material object
      const material = {
        name,
        quantity
      };
      
      // Get current item
      let item;
      
      if (currentSelection.subcategoryKey) {
        item = craftingData[currentSelection.categoryKey].subcategories[currentSelection.subcategoryKey].items
          .find(i => i.id === currentSelection.itemId);
      } else {
        item = craftingData[currentSelection.categoryKey].items
          .find(i => i.id === currentSelection.itemId);
      }
      
      // Add or update material
      const index = saveMaterialButtonEl.getAttribute('data-index');
      
      if (index === null) {
        // Add new material
        if (!item.totalMaterials) {
          item.totalMaterials = [];
        }
        
        item.totalMaterials.push(material);
      } else {
        // Update existing material
        item.totalMaterials[index] = material;
      }
      
      // Update material list
      updateMaterialList(item.totalMaterials);
      
      // Update JSON
      itemJsonEl.value = formatJSON(item);
      
      // Hide modal
      addMaterialModalEl.classList.add('hidden');
      
      // Reset index
      saveMaterialButtonEl.removeAttribute('data-index');
    }
    
    function removeMaterial(index) {
      if (!confirm('Are you sure you want to remove this material?')) {
        return;
      }
      
      // Get current item
      let item;
      
      if (currentSelection.subcategoryKey) {
        item = craftingData[currentSelection.categoryKey].subcategories[currentSelection.subcategoryKey].items
          .find(i => i.id === currentSelection.itemId);
      } else {
        item = craftingData[currentSelection.categoryKey].items
          .find(i => i.id === currentSelection.itemId);
      }
      
      // Remove material
      item.totalMaterials.splice(index, 1);
      
      // Update material list
      updateMaterialList(item.totalMaterials);
      
      // Update JSON
      itemJsonEl.value = formatJSON(item);
    }
    
    function calculateTotalMaterials() {
  // Get current item
  let item;
  
  if (currentSelection.subcategoryKey) {
    item = craftingData[currentSelection.categoryKey].subcategories[currentSelection.subcategoryKey].items
      .find(i => i.id === currentSelection.itemId);
  } else {
    item = craftingData[currentSelection.categoryKey].items
      .find(i => i.id === currentSelection.itemId);
  }
  
  if (!item.items || item.items.length === 0) {
    alert('No components to calculate materials from');
    return;
  }
  
  // Calculate total materials
  const materialsMap = new Map();
  
  // Process each component
  item.items.forEach(component => {
    // First, identify materials that have submaterials
    const materialsWithSubs = new Set();
    if (component.subMaterials) {
      Object.keys(component.subMaterials).forEach(materialName => {
        materialsWithSubs.add(materialName);
      });
    }
    
    // Process direct materials (only if they don't have submaterials)
    component.materials.forEach(material => {
      // Skip materials that have submaterials
      if (materialsWithSubs.has(material.name)) {
        return;
      }
      
      // Simply add the quantities (no multiplication)
      if (materialsMap.has(material.name)) {
        materialsMap.set(material.name, materialsMap.get(material.name) + material.quantity);
      } else {
        materialsMap.set(material.name, material.quantity);
      }
    });
    
    // Process submaterials if they exist
    if (component.subMaterials) {
      Object.entries(component.subMaterials).forEach(([materialName, subMaterials]) => {
        // Process each submaterial
        subMaterials.forEach(subMaterial => {
          // Simply add the quantities (no multiplication)
          if (materialsMap.has(subMaterial.name)) {
            materialsMap.set(subMaterial.name, materialsMap.get(subMaterial.name) + subMaterial.quantity);
          } else {
            materialsMap.set(subMaterial.name, subMaterial.quantity);
          }
        });
      });
    }
  });
  
  // Convert map to array
  const totalMaterials = Array.from(materialsMap.entries()).map(([name, quantity]) => ({
    name,
    quantity
  }));
  
  // Update item
  item.totalMaterials = totalMaterials;
  
  // Update material list
  updateMaterialList(totalMaterials);
  
  // Update JSON
  itemJsonEl.value = formatJSON(item);
  
  alert('Total materials calculated successfully');
}
    
    // Event Listeners
    
    // File Input
    loadButtonEl.addEventListener('click', () => {
      fileInputEl.click();
    });
    
    fileInputEl.addEventListener('change', (e) => {
      const file = e.target.files[0];
      
      if (file) {
        const reader = new FileReader();
        
        reader.onload = (event) => {
          try {
            const json = JSON.parse(event.target.result);
            
            // Add expanded property to categories and subcategories
            Object.values(json).forEach(category => {
              category.expanded = false;
              
              if (category.subcategories) {
                Object.values(category.subcategories).forEach(subcategory => {
                  subcategory.expanded = false;
                });
              }
            });
            
            craftingData = json;
            updateTreeView();
            showScreen(welcomeScreenEl);
            
            alert('JSON file loaded successfully');
          } catch (error) {
            alert('Error parsing JSON file: ' + error.message);
          }
        };
        
        reader.readAsText(file);
      }
    });
    
    // Save JSON
    saveButtonEl.addEventListener('click', () => {
      // Create a copy of the data without expanded properties
      const dataCopy = JSON.parse(JSON.stringify(craftingData));
      
      // Remove expanded properties
      Object.values(dataCopy).forEach(category => {
        delete category.expanded;
        
        if (category.subcategories) {
          Object.values(category.subcategories).forEach(subcategory => {
            delete subcategory.expanded;
          });
        }
      });
      
      const json = formatJSON(dataCopy);
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = 'crafting-data.json';
      a.click();
      
      URL.revokeObjectURL(url);
    });
    
    // Create New JSON
    createNewButtonEl.addEventListener('click', () => {
      if (Object.keys(craftingData).length > 0) {
        if (!confirm('This will clear all current data. Are you sure?')) {
          return;
        }
      }
      
      craftingData = {};
      updateTreeView();
      prepareAddCategory();
    });
    
    // View Full JSON
    viewJsonButtonEl.addEventListener('click', () => {
      // Create a copy of the data without expanded properties
      const dataCopy = JSON.parse(JSON.stringify(craftingData));
      
      // Remove expanded properties
      Object.values(dataCopy).forEach(category => {
        delete category.expanded;
        
        if (category.subcategories) {
          Object.values(category.subcategories).forEach(subcategory => {
            delete subcategory.expanded;
          });
        }
      });
      
      fullJsonEl.value = formatJSON(dataCopy);
      showScreen(jsonEditorScreenEl);
    });
    
    // Back Button
    backButtonEl.addEventListener('click', () => {
      if (currentSelection.type === 'category') {
        selectCategory(currentSelection.categoryKey);
      } else if (currentSelection.type === 'subcategory') {
        selectSubcategory(currentSelection.categoryKey, currentSelection.subcategoryKey);
      } else if (currentSelection.type === 'item') {
        selectItem(currentSelection.categoryKey, currentSelection.subcategoryKey, currentSelection.itemId);
      } else {
        showScreen(welcomeScreenEl);
      }
    });
    
    // Update from Full JSON
    updateFromFullJsonButtonEl.addEventListener('click', () => {
      try {
        const json = parseJSON(fullJsonEl.value);
        
        if (json) {
          // Add expanded property to categories and subcategories
          Object.values(json).forEach(category => {
            category.expanded = false;
            
            if (category.subcategories) {
              Object.values(category.subcategories).forEach(subcategory => {
                subcategory.expanded = false;
              });
            }
          });
          
          craftingData = json;
          updateTreeView();
          
          if (currentSelection.type === 'category') {
            selectCategory(currentSelection.categoryKey);
          } else if (currentSelection.type === 'subcategory') {
            selectSubcategory(currentSelection.categoryKey, currentSelection.subcategoryKey);
          } else if (currentSelection.type === 'item') {
            selectItem(currentSelection.categoryKey, currentSelection.subcategoryKey, currentSelection.itemId);
          } else {
            showScreen(welcomeScreenEl);
          }
          
          alert('JSON updated successfully');
        }
      } catch (error) {
        alert('Error parsing JSON: ' + error.message);
      }
    });
    
    // Update from Item JSON
    updateFromJsonButtonEl.addEventListener('click', () => {
      try {
        const json = parseJSON(itemJsonEl.value);
        
        if (json) {
          // Get current item
          let item;
          
          if (currentSelection.subcategoryKey) {
            const items = craftingData[currentSelection.categoryKey].subcategories[currentSelection.subcategoryKey].items;
            const index = items.findIndex(i => i.id === currentSelection.itemId);
            
            if (index !== -1) {
              items[index] = json;
            }
          } else {
            const items = craftingData[currentSelection.categoryKey].items;
            const index = items.findIndex(i => i.id === currentSelection.itemId);
            
            if (index !== -1) {
              items[index] = json;
            }
          }
          
          // Update UI
          selectItem(currentSelection.categoryKey, currentSelection.subcategoryKey, json.id);
          
          alert('Item updated successfully');
        }
      } catch (error) {
        alert('Error parsing JSON: ' + error.message);
      }
    });
    
    // Category Editor
    addCategoryButtonEl.addEventListener('click', prepareAddCategory);
    saveCategoryButtonEl.addEventListener('click', saveCategory);
    deleteCategoryButtonEl.addEventListener('click', deleteCategory);
    
    // Subcategory Editor
    addSubcategoryButtonEl.addEventListener('click', () => {
      if (Object.keys(craftingData).length === 0) {
        alert('Please create a category first');
        return;
      }
      
      prepareAddSubcategory(Object.keys(craftingData)[0]);
    });
    saveSubcategoryButtonEl.addEventListener('click', saveSubcategory);
    deleteSubcategoryButtonEl.addEventListener('click', deleteSubcategory);
    
    // Item Editor
    addItemButtonEl.addEventListener('click', () => {
      if (Object.keys(craftingData).length === 0) {
        alert('Please create a category first');
        return;
      }
      
      // Find a valid parent
      let categoryKey = Object.keys(craftingData)[0];
      let subcategoryKey = null;
      
      // Check if the category has subcategories
      if (craftingData[categoryKey].subcategories && Object.keys(craftingData[categoryKey].subcategories).length > 0) {
        subcategoryKey = Object.keys(craftingData[categoryKey].subcategories)[0];
      }
      
      prepareAddItem(categoryKey, subcategoryKey);
    });
    saveItemButtonEl.addEventListener('click', saveItem);
    deleteItemButtonEl.addEventListener('click', deleteItem);
    
    // Components
    addComponentButtonEl.addEventListener('click', addComponent);
    
    // Materials
    addMaterialButtonEl.addEventListener('click', addMaterial);
    calculateMaterialsButtonEl.addEventListener('click', calculateTotalMaterials);
    
    // Image Preview
    itemImageEl.addEventListener('input', () => {
      const url = itemImageEl.value.trim();
      
      if (url) {
        itemImagePreviewEl.src = url;
        itemImagePreviewEl.classList.remove('hidden');
      } else {
        itemImagePreviewEl.classList.add('hidden');
      }
    });
    
    // Tabs
    tabEls.forEach(tab => {
      tab.addEventListener('click', () => {
        // Remove active class from all tabs
        tabEls.forEach(t => t.classList.remove('active'));
        tabContentEls.forEach(c => c.classList.remove('active'));
        
        // Add active class to clicked tab
        tab.classList.add('active');
        
        // Show corresponding content
        const tabId = tab.getAttribute('data-tab');
        document.getElementById(`${tabId}-tab`).classList.add('active');
      });
    });
    
    // Component Modal
    closeComponentModalEl.addEventListener('click', () => {
      addComponentModalEl.classList.add('hidden');
    });
    
    cancelComponentButtonEl.addEventListener('click', () => {
      addComponentModalEl.classList.add('hidden');
    });
    
    saveComponentButtonEl.addEventListener('click', saveComponent);
    
    addComponentMaterialButtonEl.addEventListener('click', () => {
      const materialEl = document.createElement('div');
      materialEl.className = 'material-item';
      materialEl.innerHTML = `
        <input type="text" class="form-input material-item-name" placeholder="Material name">
        <input type="number" class="form-input material-item-quantity" min="1" value="1">
        <button class="button small danger remove-material-button">Remove</button>
      `;
      
      materialEl.querySelector('.remove-material-button').addEventListener('click', function() {
        this.closest('.material-item').remove();
      });
      
      componentMaterialListEl.appendChild(materialEl);
    });
    
    // Add event listener for initial material remove buttons
    document.querySelectorAll('#component-material-list .remove-material-button').forEach(button => {
      button.addEventListener('click', function() {
        this.closest('.material-item').remove();
      });
    });
    
    addSubmaterialGroupButtonEl.addEventListener('click', () => {
      // Get materials from the component
      const materials = [];
      
      componentMaterialListEl.querySelectorAll('.material-item').forEach(materialEl => {
        const materialName = materialEl.querySelector('.material-item-name').value.trim();
        
        if (materialName) {
          materials.push(materialName);
        }
      });
      
      if (materials.length === 0) {
        alert('Please add at least one material first');
        return;
      }
      
      // Populate submaterial parent dropdown
      submaterialParentEl.innerHTML = '';
      
      materials.forEach(material => {
        const option = document.createElement('option');
        option.value = material;
        option.textContent = material;
        submaterialParentEl.appendChild(option);
      });
      
      // Reset submaterial list
      submaterialListEl.innerHTML = `
        <div class="material-item">
          <input type="text" class="form-input material-item-name" placeholder="Material name">
          <input type="number" class="form-input material-item-quantity" min="1" value="1">
          <button class="button small danger remove-material-button">Remove</button>
        </div>
      `;
      
      // Add event listener for remove button
      submaterialListEl.querySelector('.remove-material-button').addEventListener('click', function() {
        this.closest('.material-item').remove();
      });
      
      // Show modal
      addSubmaterialGroupModalEl.classList.remove('hidden');
    });
    
    // Material Modal
    closeMaterialModalEl.addEventListener('click', () => {
      addMaterialModalEl.classList.add('hidden');
    });
    
    cancelMaterialButtonEl.addEventListener('click', () => {
      addMaterialModalEl.classList.add('hidden');
    });
    
    saveMaterialButtonEl.addEventListener('click', saveMaterial);
    
    // Sub-Material Group Modal
    closeSubmaterialGroupModalEl.addEventListener('click', () => {
      addSubmaterialGroupModalEl.classList.add('hidden');
    });
    
    cancelSubmaterialGroupButtonEl.addEventListener('click', () => {
      addSubmaterialGroupModalEl.classList.add('hidden');
    });
    
    addSubmaterialButtonEl.addEventListener('click', () => {
      const materialEl = document.createElement('div');
      materialEl.className = 'material-item';
      materialEl.innerHTML = `
        <input type="text" class="form-input material-item-name" placeholder="Material name">
        <input type="number" class="form-input material-item-quantity" min="1" value="1">
        <button class="button small danger remove-material-button">Remove</button>
      `;
      
      materialEl.querySelector('.remove-material-button').addEventListener('click', function() {
        this.closest('.material-item').remove();
      });
      
      submaterialListEl.appendChild(materialEl);
    });
    
    saveSubmaterialGroupButtonEl.addEventListener('click', () => {
      const parentMaterial = submaterialParentEl.value;
      
      if (!parentMaterial) {
        alert('Parent material is required');
        return;
      }
      
      // Get submaterials
      const submaterials = [];
      
      submaterialListEl.querySelectorAll('.material-item').forEach(materialEl => {
        const materialName = materialEl.querySelector('.material-item-name').value.trim();
        const materialQuantity = parseInt(materialEl.querySelector('.material-item-quantity').value, 10);
        
        if (materialName) {
          submaterials.push({
            name: materialName,
            quantity: materialQuantity
          });
        }
      });
      
      if (submaterials.length === 0) {
        alert('At least one submaterial is required');
        return;
      }
      
      // Add to component submaterials
      const submaterialGroupEl = document.createElement('div');
      submaterialGroupEl.className = 'submaterial-group';
      submaterialGroupEl.innerHTML = `
        <div class="form-group">
          <label class="form-label">Sub-Materials for ${parentMaterial}</label>
          <div class="material-list">
            ${submaterials.map(subMaterial => `
              <div class="material-item" data-parent="${parentMaterial}">
                <input type="text" class="form-input material-item-name" placeholder="Material name" value="${subMaterial.name}">
                <input type="number" class="form-input material-item-quantity" min="1" value="${subMaterial.quantity}">
                <button class="button small danger remove-material-button">Remove</button>
              </div>
            `).join('')}
          </div>
          <button class="button small add-submaterial-button" data-parent="${parentMaterial}">Add Sub-Material</button>
          <button class="button small danger remove-submaterial-group-button" data-parent="${parentMaterial}">Remove Group</button>
        </div>
      `;
      
      // Add event listeners
      submaterialGroupEl.querySelectorAll('.remove-material-button').forEach(button => {
        button.addEventListener('click', function() {
          this.closest('.material-item').remove();
        });
      });
      
      submaterialGroupEl.querySelector('.add-submaterial-button').addEventListener('click', function() {
        const parentMaterial = this.getAttribute('data-parent');
        const materialList = this.previousElementSibling;
        
        const materialEl = document.createElement('div');
        materialEl.className = 'material-item';
        materialEl.setAttribute('data-parent', parentMaterial);
        materialEl.innerHTML = `
          <input type="text" class="form-input material-item-name" placeholder="Material name">
          <input type="number" class="form-input material-item-quantity" min="1" value="1">
          <button class="button small danger remove-material-button">Remove</button>
        `;
        
        materialEl.querySelector('.remove-material-button').addEventListener('click', function() {
          this.closest('.material-item').remove();
        });
        
        materialList.appendChild(materialEl);
      });
      
      submaterialGroupEl.querySelector('.remove-submaterial-group-button').addEventListener('click', function() {
        this.closest('.submaterial-group').remove();
      });
      
      componentSubmaterialListEl.appendChild(submaterialGroupEl);
      
      // Hide modal
      addSubmaterialGroupModalEl.classList.add('hidden');
    });
    
    // Initialize
    showScreen(welcomeScreenEl);

    // Entferne den initialData-Block und ersetze ihn durch:
    // Automatisch die JSON-Datei von GitHub laden
    window.addEventListener('DOMContentLoaded', async () => {
      try {
        const url = 'https://raw.githubusercontent.com/Syntcs/elancrafting/refs/heads/main/crafting-data.json';
        const response = await fetch(url);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const json = await response.json();
        
        // Add expanded property to categories and subcategories
        Object.values(json).forEach(category => {
          category.expanded = false;
          
          if (category.subcategories) {
            Object.values(category.subcategories).forEach(subcategory => {
              subcategory.expanded = false;
            });
          }
        });
        
        craftingData = json;
        updateTreeView();
        
        // Zeige eine Erfolgsmeldung an
        const alertEl = document.createElement('div');
        alertEl.className = 'alert success';
        alertEl.textContent = 'JSON-Daten erfolgreich von GitHub geladen';
        welcomeScreenEl.prepend(alertEl);
        
        // Entferne die Meldung nach 3 Sekunden
        setTimeout(() => {
          alertEl.remove();
        }, 3000);
      } catch (error) {
        console.error('Error loading JSON from GitHub:', error);
        
        // Zeige eine Fehlermeldung an
        const alertEl = document.createElement('div');
        alertEl.className = 'alert error';
        alertEl.textContent = `Fehler beim Laden der JSON-Datei: ${error.message}`;
        welcomeScreenEl.prepend(alertEl);
      }
    });

loadUrlButtonEl.addEventListener('click', () => {
  loadUrlModalEl.classList.remove('hidden');
});

closeUrlModalEl.addEventListener('click', () => {
  loadUrlModalEl.classList.add('hidden');
});

cancelUrlButtonEl.addEventListener('click', () => {
  loadUrlModalEl.classList.add('hidden');
});

fetchUrlButtonEl.addEventListener('click', async () => {
  const url = jsonUrlEl.value.trim();
  
  if (!url) {
    alert('Please enter a valid URL');
    return;
  }
  
  try {
    // Show loading indicator
    fetchUrlButtonEl.textContent = 'Loading...';
    fetchUrlButtonEl.disabled = true;
    
    const response = await fetch(url);
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const json = await response.json();
    
    // Add expanded property to categories and subcategories
    Object.values(json).forEach(category => {
      category.expanded = false;
      
      if (category.subcategories) {
        Object.values(category.subcategories).forEach(subcategory => {
          subcategory.expanded = false;
        });
      }
    });
    
    craftingData = json;
    updateTreeView();
    showScreen(welcomeScreenEl);
    
    loadUrlModalEl.classList.add('hidden');
    alert('JSON file loaded successfully from URL');
  } catch (error) {
    alert('Error loading JSON from URL: ' + error.message);
  } finally {
    fetchUrlButtonEl.textContent = 'Load';
    fetchUrlButtonEl.disabled = false;
  }
});

// Copy JSON to clipboard
const copyJsonButtonEl = document.getElementById('copy-json-button');
copyJsonButtonEl.addEventListener('click', () => {
  const jsonText = fullJsonEl.value;
  navigator.clipboard.writeText(jsonText)
    .then(() => {
      // Show temporary success message
      const originalText = copyJsonButtonEl.textContent;
      copyJsonButtonEl.textContent = 'Copied!';
      setTimeout(() => {
        copyJsonButtonEl.textContent = originalText;
      }, 2000);
    })
    .catch(err => {
      console.error('Failed to copy: ', err);
      alert('Failed to copy to clipboard');
    });
});
  </script>
</body>
</html>
